<!DOCTYPE HTML>
<html>
<head>
	<title>box</title>
	<link type="text/css" rel="stylesheet" media="screen" href="/index.css" />
	<script src=".libs/jquery.js"></script>
	<script src=".libs/jquery-ui.js"></script>
	<script src=".libs/jquery-validate.js"></script>
</head>
<body>
	<div id="wrapper">
		<div id="header">
			BOX <span class="highlight">::</span> File-Locker des AStA der HS-Fulda
		</div>

		<div id="content">
			<div id="form_wrapper">
				<form id="form" method="post" action="/upload" enctype="multipart/form-data">
					<div id="row">
						<div id="column_left">
							<div id="file_box">
								<h1>Datei-Informationen</h1>
								<p>
									<label for="file" class="required">Datei</label><br />
									<input id="file" name="file" type="file" />
									
									<input id="file_overlay" type="text" readonly="readonly" style="display: none"/>
								</p>
								<p>
									<label for="name">Name</label><br />
									<input id="name" name="name" type="text" />
								</p>
								<p>
									<label for="description">Beschreibung</label><br />
									<textarea id="description" name="description"></textarea>
								</p>
							</div>
						</div>
						<div id="column_right">
							<div id="user_box">
								<h1>Benutzer-Informationen</h1>
								<p>
									<label for="username" class="required">Benutzer</label><br />
									<input id="username" name="username" type="text" />
								</p>
								<p>
									<label for="password" class="required">Password</label><br />
									<input id="password" name="password" type="password" />
								</p>
							</div>
							<div id="upload_box">
								<h1>Hochladen</h1>
								<p>
									<input id="terms_accepted" name="terms_accepted" type="checkbox" />
									<label for="terms_accepted" class="required"><a href="">AGBs</a> gelesen und akzeptiert</label>
								</p>
								<p>
									<input class="submit" id="submit" type="submit" value="Hochladen" />
								</p>
								
								<div id="progress">
									<div id="progress_bar"></div>
									<div id="progress_label"></div>

									<iframe id="transit" name="transit" style="display: none"></iframe>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>

		<div id="footer">
			Dieser Service ist ein Service des <a href="http://asta.hs-fulda.org">AStA der Hochschule Fulda</a>.
			<div id="info_links">
				<a href="">F.A.Q</a><br />
				<a href="">Terms of Service</a><br />
				<a href="">Privacy Policy</a><br />
			</div>
		</div>
	</div>

	<script>
		$(document).ready(function() {
			// Generate upload tracking id
			var upload_tracking_id = "";
			for (i = 0; i < 32; i++) {
				upload_tracking_id += Math.floor(Math.random() * 16).toString(16);
			}

			// Register transit iframe as target for upload form
			$("#form").attr("target", "transit");

			// Add upload tracking id to form
			$("#form").attr("action", "/upload?X-Progress-ID=" + upload_tracking_id);

			// Exchange file field with overlay and forward clicks and values
			$("#file").hide();
			$("#file").bind("change", function () { $("#file_overlay").val($("#file").val()); });
			$("#file_overlay").show();
			$("#file_overlay").bind("click", function () { $("#file").click(); });

			function validate() {
				var file = !!$("#file").val();

				var username = !!$("#username").val();
				var password = !!$("#password").val();

				var terms_accepted = !!$("#terms_accepted").attr('checked');
                
				if (file && username && password && terms_accepted) {
					$("#submit").removeAttr("disabled");
					
				} else {
					$("#submit").attr("disabled", "disabled");
				}
			}

			function upload_completed() {
				var v = $(this.contentDocument.body).html();
				alert(v);
			}

			function upload_progress_update() {
                // Get progress of upload from progress tracking server
				$.getJSON("/progress?X-Progress-ID=" + upload_tracking_id, function (data) {
					switch (data.state) {
						case "starting":
							$("#progress_bar").width("0%");
							$("#progress_label").text("Warten...");
							break;

						case "done":
							$("#progress_bar").width("100%");
							$("#progress_label").text("Fertig");
							clearInterval(upload_progress_interval);
							break;

						case "error":
							$("#progress_bar").width("0%");
							$("#progress_label").text("Fehler");
							clearInterval(upload_progress_interval);
							break;

						case "uploading":
							var f = data.received / data.size * 100.0;

							$("#progress_bar").width(f + "%");
							$("#progress_label").text(f + "%");
							break;
					}
				});
			}

			function upload() {
				// Disable input elements
				// We use the disabled class instead of the disabled attribute
				// because disabling the input element will prevent it from
				// being transmitted
				$("#form_wrapper input, #form_wrapper textarea").attr("readonly", "readonly");
				$("#form_wrapper input, #form_wrapper textarea").addClass("disabled");
				$("#file_overlay").unbind("click");
				
				// Replace submit button with progress bar
				$("#submit").parent().hide();
				$("#progress").show();

				// Register upload complete hook
				$("#transit").load(upload_completed);

				// Start uploading progress bar timer
				upload_progress_interval = setInterval(upload_progress_update, 200);

				// Continue uploading
				return true;
			}
            
            // Hook up live input validation
			$("div#form_wrapper input").on("change", validate);
			$("div#form_wrapper input").on("keyup", validate);
			$("div#form_wrapper input").on("focusout", validate);
            
            // Hookup background submit function
			$("#form").submit(upload);
            
            // Initialy validate the form
			validate();
		});
	</script>
</body>
</html>
